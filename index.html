<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üéÑ Family Christmas Lists üéÑ</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f8f4ef;
            color: #333;
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }
        h1 {
            text-align: center;
            color: #b22222;
        }
        h2 {
            border-bottom: 2px solid #b22222;
            padding-bottom: 5px;
            color: #b22222;
        }
        .person {
            margin-bottom: 2rem;
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .item:last-child {
            border-bottom: none;
        }
        button {
            background-color: #b22222;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
        }
        button:disabled {
            background-color: gray;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>üéÅ Family Christmas Lists üéÅ</h1>
    <div id="lists">Loading...</div>

    <script>
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSx8AyRPXBOoij8AoASxdVLcV3I5i_ctEQGmTJ5s2nznqL23OItItdF4uNuemjJoN6Z3fpwkmHuE-iM/pub?output=csv";
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby28JrAyaMwk10emAB5hvjFu-3Ud0qdcCnHJS1wTPl-wyrwx2g6gkxyqiO-vkvaNThl/exec";

        async function loadLists() {
            const res = await fetch(SHEET_URL);
            const text = await res.text();
            const rows = text.trim().split("\n").map(r => r.split(","));
            const header = rows.shift();
            const lists = {};

            // Build lists object
            rows.forEach(([person, item, link, purchased]) => {
                if (!lists[person]) lists[person] = [];
                const isPurchased = String(purchased).trim().toLowerCase() === "true";
                const itemObj = { item, link, purchased: isPurchased };
                lists[person].push(itemObj);
            });

            const container = document.getElementById("lists");
            container.innerHTML = "";

            // Render lists
            for (const [person, items] of Object.entries(lists)) {
                const section = document.createElement("div");
                section.classList.add("person");
                section.innerHTML = `<h2>${person}</h2>`;

                items.forEach(itemObj => {
                    const { item, link, purchased } = itemObj;
                    const div = document.createElement("div");
                    div.classList.add("item");
                    div.innerHTML = `
                        <span><a href="${link}" target="_blank">${item}</a></span>
                        <button ${purchased ? "disabled" : ""}>${purchased ? "Purchased" : "Mark Purchased"}</button>
                    `;
                    const button = div.querySelector("button");

                    if (!purchased) {
                        button.addEventListener("click", async () => {
                            button.disabled = true;
                            button.textContent = "Purchased";
                            itemObj.purchased = true; // live update locally
                            await fetch(SCRIPT_URL, {
                                method: "POST",
                                body: JSON.stringify({ person, item }),
                            });
                        });
                    }

                    section.appendChild(div);
                });

                container.appendChild(section);
            }
        }

        loadLists();
    </script>
</body>
</html>
